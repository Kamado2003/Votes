<!doctype html>
<html lang="sr">
<head>
<meta charset="utf-8">
<title>Glasanje</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family:'Poppins',sans-serif; background:linear-gradient(135deg,#fff5fb,#f2eaff); margin:0; padding:28px; color:#2a1a2b; }
.card { max-width:760px; margin:12px auto; background:#fff; border-radius:14px; padding:20px; box-shadow:0 8px 24px rgba(126,19,137,0.08); }
h1 { color:#7e1389; margin:0 0 12px; text-align:center; }
.desc { color:#6b596d; margin-bottom:16px; text-align:center; }
.song { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #f0e7f4; }
.song:last-child { border-bottom:none; }
.song .meta { max-width:70%; }
select { padding:8px; border-radius:8px; border:1px solid #e0cfe0; background:#fff; }
#username,#password { padding:10px; width:100%; border-radius:8px; border:1px solid #e0cfe0; margin-bottom:12px; }
.actions { display:flex; gap:12px; margin-top:14px; justify-content:center; flex-wrap:wrap; }
button { background:#7e1389; color:#fff; border:none; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:600; }
.result { margin-top:12px; text-align:center; font-weight:600; font-size:18px; }
.result.ok { color:#7e1389; }
.result.error { color:#cc0033; }
.password-container { position:relative; }
.password-container span { position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; user-select:none; }
.admin-log { margin-top:16px; max-height:400px; overflow:auto; border:1px solid #e0cfe0; border-radius:8px; padding:10px; background:#faf5fb; font-size:14px; }
@media(max-width:520px){.song{flex-direction:column;align-items:flex-start;gap:8px}.song .meta{max-width:100%;}}
</style>
</head>
<body>
<div class="card">
  <h1>Glasanje</h1>
  <p class="desc">Unesi svoj nick i ≈°ifru. Ako si admin, moƒái ƒáe≈° da vidi≈° log glasanja i da resetuje≈° sistem.</p>

  <input id="username" placeholder="Korisniƒçko ime">
  <div class="password-container">
    <input type="password" id="password" placeholder="≈†ifra">
    <span id="togglePass">üëÅÔ∏è</span>
  </div>

  <div id="loginArea">
    <button id="loginBtn">Prijavi se</button>
    <button id="registerBtn">Registruj se</button>
  </div>

  <div id="voteArea" style="display:none;">
    <p class="desc">Oceni pesme od 1 do 12 (bez 9 i 11). Preostale dobijaju 0.</p>
    <div id="songsContainer"></div>

    <div class="actions">
      <button id="submitBtn">Po≈°alji glasove</button>
      <button id="resetBtn">Reset glasanja</button>
    </div>

    <p id="result" class="result"></p>

    <div id="adminLog" class="admin-log" style="display:none;"></div>
  </div>
</div>

<script>
const GAS_BASE="https://script.google.com/macros/s/AKfycbzr7ZdTReJ5imoILptHb0sBdlUauRsIB0At76p9TP514RfU3uOWBRGUyogCWL6DsgO-9A/exec";
const ALLOWED=[1,2,3,4,5,6,7,8,10,12];

function createSelect(){
  const sel=document.createElement('select');
  const empty=document.createElement('option'); empty.value=""; empty.text="- 0 -"; sel.appendChild(empty);
  ALLOWED.forEach(n=>{const o=document.createElement('option'); o.value=n; o.text=n; sel.appendChild(o);});
  return sel;
}

function loadSongs(){
  const cb="cb_read_"+Date.now();
  window[cb]=function(data){
    try{
      const cont=document.getElementById('songsContainer'); cont.innerHTML="";
      if(!data.songs||data.songs.length===0){ cont.innerHTML="<p>Nema pesama u listi ü§≠</p>"; return; }
      data.songs.forEach(s=>{
        const div=document.createElement('div'); div.className='song';
        const meta=document.createElement('div'); meta.className='meta';
        meta.innerHTML="<strong>"+s.name+"</strong> <small>("+s.id+")</small>";
        const sel=createSelect(); sel.dataset.songId=s.id; div.appendChild(meta); div.appendChild(sel);
        cont.appendChild(div);
      });
    }finally{ try{ delete window[cb]; }catch(e){ window[cb]=undefined; } }
  };
  const script=document.createElement('script');
  script.src=GAS_BASE+"?action=read_songs&callback="+cb;
  document.body.appendChild(script);
}

function togglePass(){ 
  const p=document.getElementById('password');
  p.type = p.type==="password"?"text":"password";
}
document.getElementById('togglePass').addEventListener('click',togglePass);

function loginOrRegister(action){
  const username=document.getElementById('username').value.trim();
  const password=document.getElementById('password').value.trim();
  const result=document.getElementById('result'); result.textContent=""; result.className="result";
  if(!username || !password){ result.textContent="Popuni oba polja üò¢"; result.className="result error"; return; }
  const cb="cb_"+Date.now();
  window[cb]=function(data){
    try{
      if(data.ok){
        result.textContent=data.message; result.className="result ok";
        document.getElementById('loginArea').style.display="none";
        document.getElementById('voteArea').style.display="block";
        if(data.role==="admin") document.getElementById('adminLog').style.display="block";
        loadSongs();
        if(data.role==="admin") loadAdminLog();
      }else{
        result.textContent=data.error; result.className="result error";
      }
    }finally{ try{ delete window[cb]; }catch(e){ window[cb]=undefined; } }
  };
  const script=document.createElement('script');
  script.src=GAS_BASE+"?action="+action+"&username="+encodeURIComponent(username)+"&password="+encodeURIComponent(password)+"&callback="+cb;
  document.body.appendChild(script);
}

document.getElementById('loginBtn').addEventListener('click',()=>loginOrRegister("login"));
document.getElementById('registerBtn').addEventListener('click',()=>loginOrRegister("register"));

function gatherVotes(){
  const username=document.getElementById('username').value.trim();
  const result=document.getElementById('result'); result.textContent="";
  if(!username){ result.textContent="Mora≈° da unese≈° nick üíú"; result.className="result error"; return null; }
  const selects=Array.from(document.querySelectorAll('#songsContainer select'));
  if(selects.length===0){ result.textContent="Nema pesama ü§≠"; result.className="result error"; return null; }
  const votes={}; const used={};
  selects.forEach(s=>{ const id=s.dataset.songId; const val=s.value===""?0:Number(s.value); votes[id]=val; if(val!==0){ if(!used[val])used[val]=0; used[val]+=1; } });
  for(let i=0;i<ALLOWED.length;i++){
    const v=ALLOWED[i]; if(!used[v]){ result.textContent="Nedostaje broj: "+v+"ü§≠"; result.className="result error"; return null; }
    if(used[v]!==1){ result.textContent="Broj se ponavlja vi≈°e puta: "+v+"ü§≠"; result.className="result error"; return null; }
  }
  return {username:username,votes:votes};
}

function submitVotes(){
  const payload=gatherVotes(); const result=document.getElementById('result'); if(!payload)return;
  result.textContent="≈†aljem... üíú"; result.className="result ok";
  const cb="cb_submit_"+Date.now();
  window[cb]=function(data){
    try{
      if(data.ok){ result.textContent="üíú Hvala! Glasovi su zabele≈æeni! üíú"; result.className="result ok";
        document.getElementById('submitBtn').disabled=true;
        document.querySelectorAll('#songsContainer select').forEach(s=>s.disabled=true);
      }else if(data.error){ result.textContent=data.error; result.className="result error"; }
      else{ result.textContent="Do≈°lo je do gre≈°ke üòî"; result.className="result error"; }
    }finally{ try{ delete window[cb]; }catch(e){ window[cb]=undefined; } }
  };
  const script=document.createElement('script');
  script.src=GAS_BASE+"?action=submit&username="+encodeURIComponent(payload.username)+"&votes="+encodeURIComponent(JSON.stringify(payload.votes))+"&callback="+cb;
  document.body.appendChild(script);
}

document.getElementById('submitBtn').addEventListener('click',submitVotes);

function loadAdminLog(){
  const cb="cb_log_"+Date.now();
  window[cb]=function(data){
    try{
      const logDiv=document.getElementById('adminLog'); logDiv.innerHTML="";
      if(!data.log||data.log.length===0){ logDiv.innerHTML="<p>Nema glasova üò¢</p>"; return; }
      let html="<table border='1' cellpadding='4' cellspacing='0' style='width:100%; border-collapse:collapse'><tr><th>Korisnik</th><th>Datum</th><th>Pesma</th><th>Bodovi</th></tr>";
      data.log.forEach(r=>{ html+="<tr><td>"+r.username+"</td><td>"+r.datetime+"</td><td>"+r.song+"</td><td>"+r.score+"</td></tr>"; });
      html+="</table>"; logDiv.innerHTML=html;
    }finally{ try{ delete window[cb]; }catch(e){ window[cb]=undefined; } }
  };
  const script=document.createElement('script');
  script.src=GAS_BASE+"?action=get_admin_log&callback="+cb;
  document.body.appendChild(script);
}
</script>
</body>
</html>

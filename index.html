<!doctype html>
<html lang="sr">
<head>
<meta charset="utf-8">
<title>Takmiƒçenje ‚Äî Glasanje</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial,system-ui;background:linear-gradient(135deg,#fff5fb,#f2eaff);margin:0;padding:18px;color:#2a1a2b}
.container{max-width:980px;margin:0 auto}
.card{background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 8px 20px rgba(0,0,0,0.06)}
.row{display:flex;gap:12px}
.col{flex:1}
button{background:#7e1389;color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
input,select,textarea{padding:8px;border-radius:8px;border:1px solid #e0cfe0;width:100%}
.song{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f0e7f4}
.small{font-size:13px;color:#6b596d}
.hidden{display:none}
pre{background:#faf5fb;padding:8px;border-radius:8px;overflow:auto}
</style>
</head>
<body>
<div class="container">
  <!-- LOGIN / REGISTER -->
  <div class="card" id="authCard">
    <h2>Prijava / Registracija</h2>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="authUser" placeholder="Korisniƒçko ime">
      <input id="authPass" type="password" placeholder="≈†ifra">
      <span style="align-self:center"><button onclick="togglePass()">üëÅ</button></span>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <select id="regRole"><option value="user">Korisnik</option><option value="admin">Admin (samo ako nema trenutnog admina)</option></select>
      <button onclick="doRegister()">Registruj</button>
      <button onclick="doLogin()">Prijavi</button>
    </div>
    <div id="authMsg" class="small"></div>
  </div>

  <!-- USER VIEW -->
  <div class="card hidden" id="userCard">
    <h2>Glasanje</h2>
    <div class="small">Prijavljen: <span id="whoUser"></span> &nbsp;|&nbsp; Datum glasanja: <span id="voteDateUser">‚Äî</span></div>
    <div id="songsContainer" style="margin-top:12px"></div>
    <div style="margin-top:12px"><button onclick="submitVotes()">Po≈°alji glasove</button> <button onclick="logout()">Odjavi se</button></div>
    <div id="voteMsg" class="small"></div>
  </div>

  <!-- ADMIN VIEW -->
  <div class="card hidden" id="adminCard">
    <h2>Admin panel</h2>
    <div class="small">Prijavljen admin: <span id="whoAdmin"></span> &nbsp;|&nbsp; Stanje: <span id="adminState"></span> &nbsp;|&nbsp; Datum glasanja: <span id="adminDate"></span></div>

    <div style="margin-top:10px;display:flex;gap:8px">
      <button onclick="toggleVoting()">Ukljuƒçi/Iskljuƒçi glasanje</button>
      <button onclick="refreshAdmin()">Osve≈æi</button>
      <button onclick="logout()">Odjavi se</button>
    </div>

    <h3 style="margin-top:12px">Unesi do 15 pesama (songId i NAME)</h3>
    <div id="songsInputs"></div>
    <div style="margin-top:8px"><button onclick="collectAndAddSongs()">Saƒçuvaj pesme</button></div>

    <h3 style="margin-top:12px">Rezultati (sortirano po total desc)</h3>
    <div id="resultsBox"><pre>Uƒçitavanje...</pre></div>

    <h3 style="margin-top:12px">Log glasova</h3>
    <div id="votesBox"><pre>Uƒçitavanje...</pre></div>

    <div style="margin-top:12px;display:flex;gap:8px">
      <button onclick="adminResetAll()">Reset (bri≈°e glasove i pesme, ali NE korisnike)</button>
      <button onclick="adminResetAdmin()">Reset Admin (bri≈°e admin nalog)</button>
    </div>

    <div id="adminMsg" class="small"></div>
  </div>
</div>

<script>
const GAS_BASE = "https://script.google.com/macros/s/AKfycbyo_E1WnjIo5-CqK2Qm4sdXGes7ZzxHbzKqgjK983MtqkLBS5HsnTcBwgAlin2MpZ_60A/exec"; 
const ALLOWED = [1,2,3,4,5,6,7,8,10,12];
let currentUser=null;
let currentRole=null;

// JSONP helper
function jsonp(url, cb){
  const cbName = cb;
  const s = document.createElement("script");
  s.src = url + "&callback=" + cbName;
  document.head.appendChild(s);
}

// password toggle
function togglePass(){ const p=document.getElementById("authPass"); p.type = p.type==="password" ? "text" : "password"; }

// AUTH
function doRegister(){
  const u=document.getElementById("authUser").value.trim();
  const p=document.getElementById("authPass").value.trim();
  const role=document.getElementById("regRole").value;
  if(!u||!p){ document.getElementById("authMsg").textContent="Popuni user i pass"; return; }
  const cbName = "cb_reg_"+Date.now();
  window[cbName]=function(res){
    try{
      if(res.ok){ document.getElementById("authMsg").textContent="Registracija uspe≈°na ("+role+")"; }
      else document.getElementById("authMsg").textContent = res.error || "Gre≈°ka";
    }finally{ try{ delete window[cbName]; }catch(e){} }
  };
  const url = GAS_BASE + "?action=register&user="+encodeURIComponent(u)+"&pass="+encodeURIComponent(p)+"&role="+encodeURIComponent(role);
  jsonp(url, cbName);
}

function doLogin(){
  const u=document.getElementById("authUser").value.trim();
  const p=document.getElementById("authPass").value.trim();
  if(!u||!p){ document.getElementById("authMsg").textContent="Popuni user i pass"; return; }
  const cbName="cb_login_"+Date.now();
  window[cbName]=function(res){
    try{
      if(res.ok){
        currentUser = u;
        currentRole = res.role;
        document.getElementById("authCard").classList.add("hidden");
        if(res.role==="admin"){ document.getElementById("adminCard").classList.remove("hidden"); document.getElementById("whoAdmin").textContent = currentUser; loadAdmin(); }
        else { document.getElementById("userCard").classList.remove("hidden"); document.getElementById("whoUser").textContent = currentUser; loadUser(); }
      } else {
        document.getElementById("authMsg").textContent = res.error || "Gre≈°ka pri prijavi";
      }
    }finally{ try{ delete window[cbName]; }catch(e){} }
  };
  jsonp(GAS_BASE + "?action=login&user="+encodeURIComponent(u)+"&pass="+encodeURIComponent(p), cbName);
}

function logout(){
  currentUser=null; currentRole=null;
  document.getElementById("authCard").classList.remove("hidden");
  document.getElementById("userCard").classList.add("hidden");
  document.getElementById("adminCard").classList.add("hidden");
  document.getElementById("authMsg").textContent="";
  document.getElementById("voteMsg").textContent="";
  document.getElementById("adminMsg").textContent="";
}

// USER: load songs and state
function loadUser(){
  const cb="cb_load_"+Date.now();
  window[cb]=function(res){
    try{
      if(!res || !res.ok){ document.getElementById("songsContainer").innerHTML = "<div class='small'>Glasanje je zatvoreno</div>"; document.getElementById("voteDateUser").textContent = (res && res.voteDate) ? res.voteDate : "‚Äî"; return; }
      document.getElementById("voteDateUser").textContent = res.voteDate || "‚Äî";
      const box=document.getElementById("songsContainer");
      box.innerHTML="";
      res.songs.forEach(s=>{
        const div=document.createElement("div"); div.className="song";
        const meta=document.createElement("div"); meta.innerHTML="<strong>"+s.name+"</strong>";
        const sel=document.createElement("select"); sel.dataset.id=s.id;
        const o0=document.createElement("option"); o0.value=""; o0.text="- 0 -"; sel.appendChild(o0);
        ALLOWED.forEach(n=>{ const o=document.createElement("option"); o.value=n; o.text=n; sel.appendChild(o); });
        div.appendChild(meta); div.appendChild(sel); box.appendChild(div);
      });
    }finally{ try{ delete window[cb]; }catch(e){} }
  };
  jsonp(GAS_BASE + "?action=load_songs_and_state", cb);
}

function submitVotes(){
  if(!currentUser){ document.getElementById("voteMsg").textContent="Nisi prijavljen"; return; }
  const selects=document.querySelectorAll("#songsContainer select");
  const votes={}; const used={};
  selects.forEach(s=>{ const id=s.dataset.id; const v=s.value===""?0:Number(s.value); votes[id]=v; if(v!==0) used[v]=(used[v]||0)+1; });
  for(let v of ALLOWED){
    if(!used[v]){ document.getElementById("voteMsg").textContent="Nedostaje broj "+v; return; }
    if(used[v]!==1){ document.getElementById("voteMsg").textContent="Broj "+v+" se ponavlja"; return; }
  }
  document.getElementById("voteMsg").textContent="≈†aljem...";
  const cb="cb_sv_"+Date.now();
  window[cb]=function(res){
    try{ if(res.ok){ document.getElementById("voteMsg").textContent="Glasovi zabele≈æeni"; } else { document.getElementById("voteMsg").textContent = res.error || "Gre≈°ka"; } }
    finally{ try{ delete window[cb]; }catch(e){} }
  };
  jsonp(GAS_BASE + "?action=submit_vote&user="+encodeURIComponent(currentUser)+"&votes="+encodeURIComponent(JSON.stringify(votes)), cb);
}

// ADMIN: load admin data (votes, totals sorted)
function loadAdmin(){
  refreshAdmin();
  renderSongInputs(); // show 15 inputs
}

function refreshAdmin(){
  const cb="cb_admin_"+Date.now();
  window[cb]=function(res){
    try{
      if(!res || !res.ok){ document.getElementById("adminMsg").textContent="Gre≈°ka uƒçitavanja admin podataka"; return; }
      document.getElementById("adminState").textContent = res.state;
      document.getElementById("adminDate").textContent = res.voteDate || "‚Äî";
      // votes log
      const vbox = document.getElementById("votesBox");
      let vt = "";
      (res.votes||[]).forEach(r=> vt += r[0]+" | "+r[1]+" | "+r[2]+" | "+r[3]+"\n");
      vbox.innerHTML = "<pre>"+vt+"</pre>";
      // totals sorted via separate endpoint
      const cb2 = "cb_res_"+Date.now();
      window[cb2]=function(r2){
        try{
          if(!r2 || !r2.ok){ document.getElementById("resultsBox").innerHTML="<pre>No results</pre>"; return; }
          let txt = "";
          r2.results.forEach(it=> txt += it.songId + " | " + it.name + " | " + it.total + "\n");
          document.getElementById("resultsBox").innerHTML = "<pre>"+txt+"</pre>";
        }finally{ try{ delete window[cb2]; }catch(e){} }
      };
      jsonp(GAS_BASE + "?action=results_sorted", cb2);
    }finally{ try{ delete window[cb]; }catch(e){} }
  };
  jsonp(GAS_BASE + "?action=admin_data", cb);
}

function renderSongInputs(){
  const container = document.getElementById("songsInputs");
  container.innerHTML = "";
  for(let i=0;i<15;i++){
    const row = document.createElement("div"); row.style.display="flex"; row.style.gap="8px"; row.style.marginTop="6px";
    const idIn = document.createElement("input"); idIn.placeholder="songId"; idIn.style.width="30%";
    const nameIn = document.createElement("input"); nameIn.placeholder="NAME"; nameIn.style.width="65%";
    row.appendChild(idIn); row.appendChild(nameIn);
    container.appendChild(row);
  }
}

function collectAndAddSongs(){
  const rows = document.querySelectorAll("#songsInputs > div");
  const arr=[];
  rows.forEach(r=>{
    const id = r.children[0].value.trim();
    const name = r.children[1].value.trim();
    if(id && name) arr.push({id:id, name:name, initialTotal:0});
  });
  if(arr.length===0){ document.getElementById("adminMsg").textContent="Unesi bar jednu pesmu"; return; }
  const cb="cb_adds_"+Date.now();
  window[cb]=function(res){
    try{ document.getElementById("adminMsg").textContent = (res && res.ok) ? "Pesme saƒçuvane" : (res.error||"Gre≈°ka"); refreshAdmin(); }
    finally{ try{ delete window[cb]; }catch(e){} }
  };
  jsonp(GAS_BASE + "?action=add_songs&songs="+encodeURIComponent(JSON.stringify(arr)), cb);
}

function toggleVoting(){
  const cb="cb_toggle_"+Date.now();
  window[cb]=function(res){ try{ document.getElementById("adminMsg").textContent = (res && res.ok) ? ("Novo stanje: " + res.state) : (res.error||"Gre≈°ka"); refreshAdmin(); } finally{ try{ delete window[cb]; }catch(e){} } };
  jsonp(GAS_BASE + "?action=toggle_voting", cb);
}

function adminResetAll(){
  if(!confirm("Ovo bri≈°e SVE glasove i PESME i totals. Nastavi?")) return;
  const cb="cb_reset_"+Date.now();
  window[cb]=function(res){ try{ document.getElementById("adminMsg").textContent = (res && res.ok) ? "Reset izvr≈°en" : (res.error||"Gre≈°ka"); refreshAdmin(); } finally{ try{ delete window[cb]; }catch(e){} } };
  jsonp(GAS_BASE + "?action=reset_all", cb);
}

function adminResetAdmin(){
  if(!confirm("Ovo bri≈°e ADMIN nalog. Nastavi?")) return;
  const cb="cb_resetadm_"+Date.now();
  window[cb]=function(res){ try{ document.getElementById("adminMsg").textContent = (res && res.ok) ? "Admin obrisan" : (res.error||"Gre≈°ka"); logout(); } finally{ try{ delete window[cb]; }catch(e){} } };
  jsonp(GAS_BASE + "?action=reset_admin", cb);
}

// refresh helper
function refreshAdminAndUser(){
  if(currentRole==="admin") refreshAdmin();
  if(currentRole==="user") loadUser();
}
</script>
</body>
</html>

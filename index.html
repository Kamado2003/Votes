<!doctype html>
<html lang="sr">
<head>
<meta charset="utf-8">
<title>Glasanje</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{
  font-family: 'Roboto', Arial, system-ui;
  background: linear-gradient(135deg,#fff5fb,#f2eaff);
  margin:0;padding:18px;color:#2a1a2b;
}
.container{max-width:980px;margin:0 auto}
.card{
  background:#fff;
  border-radius:14px;
  padding:20px;
  margin-bottom:16px;
  box-shadow:0 10px 25px rgba(0,0,0,0.08);
  transition: transform 0.2s, box-shadow 0.2s;
}
.card:hover{
  transform: translateY(-3px);
  box-shadow:0 15px 30px rgba(0,0,0,0.12);
}
h2,h3{margin-top:0;color:#7e1389}
.row{display:flex;gap:12px}
.col{flex:1}
button{
  background:#7e1389;
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:10px;
  cursor:pointer;
  transition: background 0.2s;
}
button:hover{background:#9e1fb5}
input,select,textarea{
  padding:10px;
  border-radius:8px;
  border:1px solid #e0cfe0;
  width:100%;
  transition: border-color 0.2s;
}
input:focus,select:focus,textarea:focus{border-color:#7e1389;outline:none}
.song{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px;
  border-bottom:1px solid #f0e7f4;
  transition: background 0.2s;
}
.song:hover{background:#f9f2fd}
.small{font-size:13px;color:#6b596d}
.hidden{display:none}
pre{
  background:#faf5fb;
  padding:8px;
  border-radius:8px;
  overflow:auto;
}
#resultsChart{margin-top:12px;}
</style>
</head>
<body>
<div class="container">

  <!-- LOGIN / REGISTER -->
  <div class="card" id="authCard">
    <h2>Prijava / Registracija</h2>
    <h2>‚ö†Ô∏è Nemojte unositi lozinku koju koristite za forum! Nick treba da ostane isti.</h2>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="authUser" placeholder="Nick sa foruma">
      <input id="authPass" type="password" placeholder="Lozinka">
      <span style="align-self:center"><button onclick="togglePass()">üëÅ</button></span>
    </div>
    <div style="display:flex;gap:7px;margin-bottom:7px">
      <select id="regRole"><option value="user">Takmiƒçar</option><option value="admin">Voditelj (samo 1 istovremeno)</option></select>
      <button onclick="doRegister()">Registracija</button>
      <button onclick="doLogin()">Prijava</button>
    </div>
    <div id="authMsg" class="small"></div>
  </div>

  <!-- USER VIEW -->
  <div class="card hidden" id="userCard">
    <h2>Glasanje</h2>
    <div class="small">Prijavljeni takmiƒçar üëâ: <span id="whoUser"></span> &nbsp;|&nbsp; Datum glasanja: <span id="voteDateUser">‚Äî</span></div>
    <div id="songsContainer" style="margin-top:12px"></div>
    <div style="margin-top:12px"><button onclick="submitVotes()">Po≈°alji glasove</button> <button onclick="logout()">Odjavi se</button></div>
    <div id="voteMsg" class="small"></div>
  </div>

  <!-- ADMIN VIEW -->
  <div class="card hidden" id="adminCard">
    <h2>Admin panel üìä</h2>
    <div class="small">Prijavljeni voditelj üëâ: <span id="whoAdmin"></span> &nbsp;|&nbsp; Glasanje: <span id="adminState"></span> &nbsp;|&nbsp; Datum glasanja: <span id="adminDate">‚Äî</span></div>

    <div style="margin-top:10px;display:flex;gap:8px">
      <button onclick="toggleVoting()">Ukljuƒçi/Iskljuƒçi glasanje</button>
      <button onclick="refreshAdmin()">Osve≈æi stranicu</button>
      <button onclick="logout()">Odjavi se</button>
    </div>

    <h3 style="margin-top:12px">Unesi do 15 pesama (redni broj i izvoƒëaƒç - naziv pesme)</h3>
    <div id="songsInputs"></div>
    <div style="margin-top:8px"><button onclick="collectAndAddSongs()">Saƒçuvaj pesme</button></div>

    <h3 style="margin-top:12px">Rezultati</h3>
    <canvas id="resultsChart" width="400" height="200"></canvas>
    <div id="resultsBox"><pre>Uƒçitavanje...</pre></div>

    <h3 style="margin-top:12px">Istorija glasova</h3>
    <div id="votesBox"><pre>Uƒçitavanje...</pre></div>

    <div style="margin-top:12px;display:flex;gap:8px">
      <button onclick="adminResetAll()">Reset (bri≈°e glasove i pesme)</button>
      <button onclick="adminResetAdmin()">Reset Admin (bri≈°e nalog voditelja na kraju takmiƒçenja!)</button>
    </div>

    <div id="adminMsg" class="small"></div>
  </div>
</div>

<script>
const GAS_BASE = "https://script.google.com/macros/s/AKfycbwJUXNf84IJ5Tu6pgguneeroevDVycY7vgWYa_WzE-Ac046b3sDHrrvLvduXZkUS79naw/exec"; 
const ALLOWED = [1,2,3,4,5,6,7,8,10,12];
let currentUser=null;
let currentRole=null;
let chart=null;

function jsonp(url, cb){
  const cbName = cb;
  const s = document.createElement("script");
  s.src = url + "&callback=" + cbName;
  document.head.appendChild(s);
}
function togglePass(){ const p=document.getElementById("authPass"); p.type = p.type==="password" ? "text" : "password"; }

function doRegister(){
  const u=document.getElementById("authUser").value.trim();
  const p=document.getElementById("authPass").value.trim();
  const role=document.getElementById("regRole").value;
  if(!u||!p){ document.getElementById("authMsg").textContent="Unesi nick i lozinku"; return; }
  const cbName = "cb_reg_"+Date.now();
  window[cbName]=function(res){ try{ document.getElementById("authMsg").textContent=res.ok?"Registracija uspe≈°na! ("+role+")":(res.error||"Gre≈°ka"); }finally{ try{ delete window[cbName]; }catch(e){} } };
  jsonp(GAS_BASE + "?action=register&user="+encodeURIComponent(u)+"&pass="+encodeURIComponent(p)+"&role="+encodeURIComponent(role), cbName);
}

function doLogin(){
  const u=document.getElementById("authUser").value.trim();
  const p=document.getElementById("authPass").value.trim();
  if(!u||!p){ document.getElementById("authMsg").textContent="Mora≈° da unese≈° nick sa foruma i lozinku (NE ista kao sa foruma)‚ö†Ô∏è"; return; }
  const cbName="cb_login_"+Date.now();
  window[cbName]=function(res){
    try{
      if(res.ok){
        currentUser = u;
        currentRole = res.role;
        document.getElementById("authCard").classList.add("hidden");
        if(res.role==="admin"){ document.getElementById("adminCard").classList.remove("hidden"); document.getElementById("whoAdmin").textContent = currentUser; loadAdmin(); }
        else { document.getElementById("userCard").classList.remove("hidden"); document.getElementById("whoUser").textContent = currentUser; loadUser(); }
      } else { document.getElementById("authMsg").textContent = res.error || "Gre≈°ka pri prijavi ‚ö†Ô∏è"; }
    }finally{ try{ delete window[cbName]; }catch(e){} }
  };
  jsonp(GAS_BASE + "?action=login&user="+encodeURIComponent(u)+"&pass="+encodeURIComponent(p), cbName);
}

function logout(){
  currentUser=null; currentRole=null;
  document.getElementById("authCard").classList.remove("hidden");
  document.getElementById("userCard").classList.add("hidden");
  document.getElementById("adminCard").classList.add("hidden");
  document.getElementById("authMsg").textContent="";
  document.getElementById("voteMsg").textContent="";
  document.getElementById("adminMsg").textContent="";
}

// date format
function formatDate(dt){ 
  if(!dt) return "‚Äî";
  const d = new Date(dt);
  const pad=(n)=>n.toString().padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

// USER
function loadUser(){
  const cb="cb_load_"+Date.now();
  window[cb]=function(res){
    try{
      document.getElementById("voteDateUser").textContent = formatDate(res?.voteDate);
      const box=document.getElementById("songsContainer"); box.innerHTML="";
      if(!res?.ok || !res.songs){ box.innerHTML="<div class='small'>Glasanje je zatvoreno üòî</div>"; return; }
      res.songs.forEach(s=>{
        const div=document.createElement("div"); div.className="song";
        const meta=document.createElement("div"); meta.innerHTML="<strong>"+s.name+"</strong>";
        const sel=document.createElement("select"); sel.dataset.id=s.id;
        const o0=document.createElement("option"); o0.value=""; o0.text="- 0 -"; sel.appendChild(o0);
        ALLOWED.forEach(n=>{ const o=document.createElement("option"); o.value=n; o.text=n; sel.appendChild(o); });
        div.appendChild(meta); div.appendChild(sel); box.appendChild(div);
      });
    }finally{ try{ delete window[cb]; }catch(e){} }
  };
  jsonp(GAS_BASE + "?action=load_songs_and_state", cb);
}

function submitVotes(){
  if(!currentUser){ document.getElementById("voteMsg").textContent="Mora≈° da se prijavi≈° üòî"; return; }
  const selects=document.querySelectorAll("#songsContainer select");
  const votes={}; const used={};
  selects.forEach(s=>{ const id=s.dataset.id; const v=s.value===""?0:Number(s.value); votes[id]=v; if(v!==0) used[v]=(used[v]||0)+1; });
  for(let v of ALLOWED){ if(!used[v]){ document.getElementById("voteMsg").textContent="Nedostaje broj "+v; return; } if(used[v]!==1){ document.getElementById("voteMsg").textContent="Broj "+v+" se ponavlja"; return; } }
  document.getElementById("voteMsg").textContent="≈†aljem... üíú";
  const cb="cb_sv_"+Date.now();
  window[cb]=function(res){ try{ document.getElementById("voteMsg").textContent=res.ok?"Hvala üíú Tvoji glasovi su zabele≈æeni!":(res.error||"Gre≈°ka ‚ö†Ô∏è"); }finally{ try{ delete window[cb]; }catch(e){} } };
  jsonp(GAS_BASE + "?action=submit_vote&user="+encodeURIComponent(currentUser)+"&votes="+encodeURIComponent(JSON.stringify(votes)), cb);
}

// ADMIN
function loadAdmin(){
  refreshAdmin();
  renderSongInputs();
}

function refreshAdmin(){
  const cb="cb_admin_"+Date.now();
  window[cb]=function(res){
    try{
      if(!res?.ok){ document.getElementById("adminMsg").textContent="Gre≈°ka uƒçitavanja admin podataka ‚ö†Ô∏è"; return; }
      document.getElementById("adminState").textContent=res.state;
      document.getElementById("adminDate").textContent=formatDate(res.voteDate);
      
      const vbox = document.getElementById("votesBox");
      let vt = ""; (res.votes||[]).forEach(r=> vt += r[0]+" | "+r[1]+" | "+r[2]+" | "+r[3]+"\n");
      vbox.innerHTML = "<pre>"+vt+"</pre>";

      const cb2 = "cb_res_"+Date.now();
      window[cb2]=function(r2){
        try{
          if(!r2?.ok){ document.getElementById("resultsBox").innerHTML="<pre>Nema rezultata ‚ö†Ô∏è</pre>"; return; }
          let txt=""; r2.results.forEach(it=> txt += it.songId + " | " + it.name + " | " + it.total + "\n");
          document.getElementById("resultsBox").innerHTML="<pre>"+txt+"</pre>";
          renderChart(r2.results);
        }finally{ try{ delete window[cb2]; }catch(e){} }
      };
      jsonp(GAS_BASE + "?action=results_sorted", cb2);
    }finally{ try{ delete window[cb]; }catch(e){} }
  };
  jsonp(GAS_BASE + "?action=admin_data", cb);
}

function renderChart(results){
  const labels = results.map(it=>it.name);
  const data = results.map(it=>it.total);
  const colors = labels.map((_,i)=>`hsl(${i*35 % 360}, 65%, 55%)`);
  if(chart) chart.destroy();
  const ctx = document.getElementById('resultsChart').getContext('2d');
  chart = new Chart(ctx,{
    type:'bar',
    data:{labels:labels,datasets:[{label:'Ukupno glasova',data:data,backgroundColor:colors,borderRadius:8,borderSkipped:false}]},
    options:{
      responsive:true,
      animation:{duration:800,easing:'easeOutQuart'},
      plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>ctx.dataset.label+": "+ctx.parsed.y}}},
      scales:{y:{beginAtZero:true,ticks:{stepSize:1}},x:{ticks:{autoSkip:false}}}
    }
  });
}

function renderSongInputs(){
  const container=document.getElementById("songsInputs");
  container.innerHTML="";
  for(let i=0;i<15;i++){
    const row=document.createElement("div");
    row.style.display="flex"; row.style.gap="8px"; row.style.marginTop="6px";
    const idIn=document.createElement("input"); idIn.placeholder="songId"; idIn.style.width="30%";
    const nameIn=document.createElement("input"); nameIn.placeholder="NAME"; nameIn.style.width="65%";
    row.appendChild(idIn); row.appendChild(nameIn);
    container.appendChild(row);
  }
}

function collectAndAddSongs(){
  const rows=document.querySelectorAll("#songsInputs > div");
  const arr=[];
  rows.forEach(r=>{ const id=r.children[0].value.trim(); const name=r.children[1].value.trim(); if(id && name) arr.push({id:id,name:name,initialTotal:0}); });
  if(arr.length===0){ document.getElementById("adminMsg").textContent="Unesi bar jednu pesmu ‚ö†Ô∏è"; return; }
  const cb="cb_adds_"+Date.now();
  window[cb]=function(res){ try{ document.getElementById("adminMsg").textContent=(res?.ok)?"Pesme saƒçuvane ‚úÖÔ∏è":(res.error||"Gre≈°ka"); refreshAdmin(); }finally{ try{ delete window[cb]; }catch(e){} } };
  jsonp(GAS_BASE + "?action=add_songs&songs="+encodeURIComponent(JSON.stringify(arr)), cb);
}

function toggleVoting(){
  const cb="cb_toggle_"+Date.now();
  window[cb]=function(res){ try{ document.getElementById("adminMsg").textContent=res?.ok?"Novo stanje: "+res.state:(res.error||"Gre≈°ka"); refreshAdmin(); }finally{ try{ delete window[cb]; }catch(e){} } };
  jsonp(GAS_BASE + "?action=toggle_voting", cb);
}

function adminResetAll(){
  if(!confirm("Ovo bri≈°e SVE glasove, PESME i ZBIR glasova. Nastavi?")) return;
  const cb="cb_reset_"+Date.now();
  window[cb]=function(res){ try{ document.getElementById("adminMsg").textContent=res?.ok?"Reset izvr≈°en ‚úÖÔ∏è":(res.error||"Gre≈°ka"); refreshAdmin(); }finally{ try{ delete window[cb]; }catch(e){} } };
  jsonp(GAS_BASE + "?action=reset_all", cb);
}

function adminResetAdmin(){
  if(!confirm("Ovo bri≈°e VODITELJ nalog. Nastavi?")) return;
  const cb="cb_resetadm_"+Date.now();
  window[cb]=function(res){ try{ document.getElementById("adminMsg").textContent=res?.ok?"Voditelj obrisan ‚úÖÔ∏è":(res.error||"Gre≈°ka"); if(res?.ok) logout(); }finally{ try{ delete window[cb]; }catch(e){} } };
  jsonp(GAS_BASE + "?action=reset_admin", cb);
}
</script>
</body>
</html>


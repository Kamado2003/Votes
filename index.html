<!doctype html>
<html lang="sr">
<head>
<meta charset="utf-8">
<title>Takmiƒçenje ‚Äî Glasanje</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial,system-ui;background:linear-gradient(135deg,#fff5fb,#f2eaff);margin:0;padding:18px;color:#2a1a2b}
.container{max-width:980px;margin:0 auto}
.card{background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 8px 20px rgba(0,0,0,0.06)}
.row{display:flex;gap:12px}
.col{flex:1}
button{background:#7e1389;color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
input,select,textarea{padding:8px;border-radius:8px;border:1px solid #e0cfe0;width:100%}
.song{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f0e7f4}
.small{font-size:13px;color:#6b596d}
.hidden{display:none}
pre{background:#faf5fb;padding:8px;border-radius:8px;overflow:auto}
</style>
</head>
<body>
<div class="container">
  <!-- LOGIN / REGISTER -->
  <div class="card" id="authCard">
    <h2>Prijava / Registracija</h2>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="authUser" placeholder="Korisniƒçko ime">
      <input id="authPass" type="password" placeholder="≈†ifra">
      <span style="align-self:center"><button onclick="togglePass()">üëÅ</button></span>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <select id="regRole"><option value="user">Korisnik</option><option value="admin">Admin (samo ako nema trenutnog admina)</option></select>
      <button onclick="doRegister()">Registruj</button>
      <button onclick="doLogin()">Prijavi</button>
    </div>
    <div id="authMsg" class="small"></div>
  </div>

  <!-- USER VIEW -->
  <div class="card hidden" id="userCard">
    <h2>Glasanje</h2>
    <div class="small">Prijavljen: <span id="whoUser"></span> &nbsp;|&nbsp; Datum glasanja: <span id="voteDateUser">‚Äî</span></div>
    <div id="songsContainer" style="margin-top:12px"></div>
    <div style="margin-top:12px"><button onclick="submitVotes()">Po≈°alji glasove</button> <button onclick="logout()">Odjavi se</button></div>
    <div id="voteMsg" class="small"></div>
  </div>

  <!-- ADMIN VIEW -->
  <div class="card hidden" id="adminCard">
    <h2>Admin panel</h2>
    <div class="small">Prijavljen admin: <span id="whoAdmin"></span> &nbsp;|&nbsp; Stanje: <span id="adminState"></span> &nbsp;|&nbsp; Datum glasanja: <span id="adminDate"></span></div>

    <div style="margin-top:10px;display:flex;gap:8px">
      <button onclick="toggleVoting()">Ukljuƒçi/Iskljuƒçi glasanje</button>
      <button onclick="refreshAdmin()">Osve≈æi</button>
      <button onclick="logout()">Odjavi se</button>
    </div>

    <h3 style="margin-top:12px">Unesi do 15 pesama (songId i NAME)</h3>
    <div id="songsInputs"></div>
    <div style="margin-top:8px"><button onclick="collectAndAddSongs()">Saƒçuvaj pesme</button></div>

    <h3 style="margin-top:12px">Rezultati (sortirano po total desc)</h3>
    <div id="resultsBox"><pre>Uƒçitavanje...</pre></div>

    <h3 style="margin-top:12px">Log glasova</h3>
    <div id="votesBox"><pre>Uƒçitavanje...</pre></div>

    <div style="margin-top:12px;display:flex;gap:8px">
      <button onclick="adminResetAll()">Reset (bri≈°e glasove i pesme, ali NE korisnike)</button>
      <button onclick="adminResetAdmin()">Reset Admin (bri≈°e admin nalog)</button>
    </div>

    <div id="adminMsg" class="small" style="font-size:16px;"></div>
  </div>
</div>

<script>
const GAS_BASE = "https://script.google.com/macros/s/AKfycbwK2-1FtQIbWR3OZfGreoPnTdBLQ0h2ghPx_X-7F8WmUP0KeMeK03S-6JaQV4rLB1B1oQ/exec"; // 
const ALLOWED = [1,2,3,4,5,6,7,8,10,12];
let currentUser=null;
let currentRole=null;

function jsonp(url, cb){
  const cbName = cb;
  const s = document.createElement("script");
  s.src = url + "&callback=" + cbName;
  document.head.appendChild(s);
}

function togglePass(){ const p=document.getElementById("authPass"); p.type = p.type==="password" ? "text" : "password"; }

function doRegister(){ /*  */ }
function doLogin(){ /*  */ }
function logout(){ /* */ }

function loadUser(){ /*  */ }
function submitVotes(){ /*  */ }

function loadAdmin(){ refreshAdmin(); renderSongInputs(); }
function refreshAdmin(){
  const cb="cb_admin_"+Date.now();
  window[cb]=function(res){
    try{
      if(!res || !res.ok){ document.getElementById("adminMsg").textContent="Gre≈°ka uƒçitavanja admin podataka"; return; }
      document.getElementById("adminState").textContent = res.state;
      document.getElementById("adminDate").textContent = res.voteDate || "‚Äî";

      // log glasova sa skraƒáenim datumom i veƒáim slovima
      const vbox = document.getElementById("votesBox");
      let vt = "";
      (res.votes||[]).forEach(r=>{
        let shortDate = r[3] ? r[3].split(" ")[0] : ""; // samo datum
        vt += r[0]+" | "+r[1]+" | "+r[2]+" | "+shortDate+"\n";
      });
      vbox.innerHTML = "<pre style='font-size:16px'>"+vt+"</pre>";

      // totals sorted
      const cb2="cb_res_"+Date.now();
      window[cb2]=function(r2){
        try{
          if(!r2 || !r2.ok){ document.getElementById("resultsBox").innerHTML="<pre>No results</pre>"; return; }
          let txt = "";
          r2.results.forEach(it=> txt += it.songId + " | " + it.name + " | " + it.total + "\n");
          document.getElementById("resultsBox").innerHTML = "<pre>"+txt+"</pre>";
        }finally{ try{ delete window[cb2]; }catch(e){} }
      };
      jsonp(GAS_BASE + "?action=results_sorted", cb2);
    }finally{ try{ delete window[cb]; }catch(e){} }
  };
  jsonp(GAS_BASE + "?action=admin_data", cb);
}

function renderSongInputs(){ /*  */ }
function collectAndAddSongs(){ /*  */ }
function toggleVoting(){ /*  */ }
function adminResetAll(){ /*  */ }
function adminResetAdmin(){ /*  */ }

function refreshAdminAndUser(){ /*  */ }
</script>
</body>
</html>
